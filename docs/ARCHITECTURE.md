# システムアーキテクチャ

## 全体構成図

```
┌────────────────────────────────────────────────────────────────────────────┐
│                              AWS Cloud                                      │
│                                                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                     AgentCore Runtime                                 │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │  Strands Agent                                                   │ │  │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │ │  │
│  │  │  │  list_kbs   │  │  kb_search  │  │ auto_search │              │ │  │
│  │  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘              │ │  │
│  │  │         │                │                │                      │ │  │
│  │  │         └────────────────┼────────────────┘                      │ │  │
│  │  │                          │                                       │ │  │
│  │  │                          ▼                                       │ │  │
│  │  │              ┌───────────────────────┐                          │ │  │
│  │  │              │  Gateway Client       │                          │ │  │
│  │  │              │  (SigV4 + MCP)        │                          │ │  │
│  │  │              └───────────┬───────────┘                          │ │  │
│  │  └──────────────────────────┼──────────────────────────────────────┘ │  │
│  └─────────────────────────────┼────────────────────────────────────────┘  │
│                                │                                            │
│                                │ HTTPS (IAM認証)                            │
│                                ▼                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                     AgentCore Gateway                                 │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │  MCP Protocol Handler                                           │ │  │
│  │  │  - tools/list                                                   │ │  │
│  │  │  - tools/call                                                   │ │  │
│  │  └─────────────────────────────────────────────────────────────────┘ │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │  Target: kb-search-target                                       │ │  │
│  │  │  - target-xxx___list_kbs                                        │ │  │
│  │  │  - target-xxx___kb_search                                       │ │  │
│  │  │  - target-xxx___auto_search                                     │ │  │
│  │  └─────────────────────────────────────────────────────────────────┘ │  │
│  └─────────────────────────────┬────────────────────────────────────────┘  │
│                                │                                            │
│                                │ Lambda Invoke                              │
│                                ▼                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                     Lambda Function                                   │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │  KB Search Handler                                              │ │  │
│  │  │  - クエリ分解                                                    │ │  │
│  │  │  - ハイブリッド検索                                              │ │  │
│  │  │  - リランキング                                                  │ │  │
│  │  └─────────────────────────────────────────────────────────────────┘ │  │
│  └─────────────────────────────┬────────────────────────────────────────┘  │
│                                │                                            │
│                                │ Bedrock API                                │
│                                ▼                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                     Bedrock Knowledge Base                            │  │
│  │  ┌─────────────────┐  ┌─────────────────┐                            │  │
│  │  │  product_docs   │  │      faq        │                            │  │
│  │  │  (認証マニュアル) │  │  (サンプル)     │                            │  │
│  │  └─────────────────┘  └─────────────────┘                            │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

## データフロー

### 1. ユーザーリクエスト

```
ユーザー: "認証について検索して"
    │
    ▼
agentcore invoke '{"prompt": "認証について検索して"}'
    │
    ▼
AgentCore Runtime (app.py → main.py)
```

### 2. エージェント処理

```
Strands Agent
    │
    ├─ システムプロンプト解析
    │
    ├─ ツール選択: kb_search
    │
    └─ ツール実行
        │
        ▼
    call_gateway_tool("kb_search", {
        "kb_name": "product_docs",
        "query": "認証"
    })
```

### 3. Gateway呼び出し

```
Gateway Client
    │
    ├─ JSON-RPC 2.0 ペイロード作成
    │   {
    │     "jsonrpc": "2.0",
    │     "method": "tools/call",
    │     "params": {
    │       "name": "target-xxx___kb_search",
    │       "arguments": {...}
    │     }
    │   }
    │
    ├─ SigV4署名
    │
    └─ HTTPS POST → Gateway
```

### 4. Lambda実行

```
Lambda Function
    │
    ├─ イベント解析
    │
    ├─ クエリ分解
    │
    ├─ Bedrock KB検索
    │
    └─ レスポンス返却
        {
          "statusCode": 200,
          "body": "{...検索結果...}"
        }
```

### 5. レスポンス処理

```
Gateway → Agent
    │
    ├─ MCPレスポンスパース
    │
    ├─ Lambda結果抽出
    │
    └─ エージェントに返却
        │
        ▼
    Strands Agent
        │
        └─ 検索結果を元に回答生成
            │
            ▼
        ユーザーへ回答
```

## コンポーネント詳細

### AgentCore Runtime

| ファイル | 役割 |
|---------|------|
| `app.py` | エントリーポイント、BedrockAgentCoreApp |
| `main.py` | エージェント構築、Gateway呼び出しロジック |

### AgentCore Gateway

| 設定 | 値 |
|------|-----|
| 認証方式 | AWS_IAM |
| プロトコル | MCP (2025-11-25) |
| ターゲット | Lambda関数 |

### Lambda Function

| ファイル | 役割 |
|---------|------|
| `lambda_function.py` | メインハンドラー、ツール実装 |
| `kb_config.py` | ナレッジベース設定 |

## セキュリティ

### IAM認証

- AgentCore RuntimeはIAMロールで実行
- Gateway呼び出しはSigV4署名で認証
- Lambda関数はGatewayからのみ呼び出し可能

### 必要なIAM権限

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "bedrock-agentcore:InvokeGateway",
      "Resource": "arn:aws:bedrock-agentcore:*:*:gateway/*"
    },
    {
      "Effect": "Allow",
      "Action": "bedrock-agent-runtime:Retrieve",
      "Resource": "arn:aws:bedrock:*:*:knowledge-base/*"
    }
  ]
}
```
